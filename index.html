<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TPV Zona de Juegos - CRM en Lempiras</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6e6e6; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #161b22; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    .btn-primary { transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 255, 127, 0.1), 0 2px 4px -2px rgba(0, 255, 127, 0.1); }
    .btn-primary:hover { background-color: #00e073; box-shadow: 0 10px 15px -3px rgba(0, 255, 127, 0.3), 0 4px 6px -4px rgba(0, 255, 127, 0.3); }
    .console-card { background-color: #161b22; border: 1px solid #30363d; transition: transform 0.3s; }
    .console-card:hover { border-color: #00f080; transform: translateY(-2px); }
    .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
    #client-suggestions { max-height: 200px; overflow-y: auto; border: 1px solid #30363d; background-color: #0d1117; position: absolute; width: calc(100% - 3rem); z-index: 10; border-radius: 0 0 8px 8px; margin-top: -8px; }
    .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #161b22; }
    .suggestion-item:hover { background-color: #30363d; }
  </style>
</head>

<body class="p-4 md:p-8">
  <header class="text-center mb-10">
    <h1 class="text-4xl font-extrabold text-[#00f080] mb-2">üéÆ TPV Zona de Juegos + CRM</h1>
    <p class="text-gray-400">Gestor de Consolas y Clientes (Tarifas en Lempiras HNL)</p>
    <p id="auth-status" class="text-xs mt-1 text-gray-500">Autenticando...</p>
  </header>

  <!-- Modal de Configuraci√≥n de Precios -->
  <div id="price-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"
       onclick="if(event.target.id === 'price-modal') toggleModal('price-modal')">
    <div class="bg-[#1e2329] p-6 rounded-xl w-full max-w-md shadow-2xl">
      <h2 class="text-2xl font-bold mb-4 text-[#00f080]">Configurar Tarifas (HNL)</h2>

      <label class="block mb-2 text-sm font-medium text-gray-300" for="price-hour">Costo por Hora (HNL):</label>
      <input type="number" id="price-hour" class="w-full p-2 mb-4 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500" value="30">

      <label class="block mb-2 text-sm font-medium text-gray-300" for="price-half-hour">Costo por Media Hora (HNL):</label>
      <input type="number" id="price-half-hour" class="w-full p-2 mb-4 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500" value="20">

      <label class="block mb-2 text-sm font-medium text-gray-300" for="price-extra-controller">Costo por Control Extra (HNL):</label>
      <input type="number" id="price-extra-controller" class="w-full p-2 mb-6 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500" value="5">

      <div class="flex justify-end">
        <button onclick="toggleModal('price-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition">Cancelar</button>
        <button onclick="savePrices()" class="btn-primary bg-[#00d073] text-[#161b22] font-bold py-2 px-4 rounded-lg">Guardar Tarifas</button>
      </div>
      <p id="price-error" class="text-sm text-red-400 mt-3 hidden">Error al guardar precios.</p>
    </div>
  </div>

  <!-- Modal de Iniciar Sesi√≥n -->
  <div id="start-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"
       onclick="if(event.target.id === 'start-modal') toggleModal('start-modal')">
    <div class="bg-[#1e2329] p-6 rounded-xl w-full max-w-md shadow-2xl">
      <h2 id="start-modal-title" class="text-2xl font-bold mb-4 text-[#00f080]">Iniciar Sesi√≥n</h2>

      <div class="mb-6 relative">
        <h3 class="text-lg font-semibold text-gray-300 mb-2">Datos del Cliente</h3>

        <label class="block mb-2 text-sm font-medium text-gray-300" for="client-name-input">Nombre del Cliente:</label>
        <input type="text" id="client-name-input" oninput="searchClients(this.value)"
               class="w-full p-2 mb-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500"
               placeholder="Ej: Juan P√©rez">
        <div id="client-suggestions" class="absolute left-0 right-0"></div>

        <label class="block mb-2 text-sm font-medium text-gray-300" for="client-whatsapp-input">N√∫mero de WhatsApp:</label>
        <input type="text" id="client-whatsapp-input"
               class="w-full p-2 mb-4 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500"
               placeholder="Ej: 99887766 (Opcional)">
        <input type="hidden" id="client-db-id">
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-300 mb-2">Detalles de la Sesi√≥n</h3>

        <label class="block mb-2 text-sm font-medium text-gray-300" for="session-console">Consola:</label>
        <select id="session-console" class="w-full p-2 mb-4 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500">
          <option value="Xbox">Xbox</option>
          <option value="PS4">PS4</option>
          <option value="Switch">Switch</option>
          <option value="PC">PC</option>
        </select>

        <label class="block mb-2 text-sm font-medium text-gray-300" for="session-controllers">Controles Extra (0 - 4):</label>
        <input type="number" id="session-controllers" min="0" max="4"
               class="w-full p-2 mb-6 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-green-500 focus:border-green-500"
               value="0">
      </div>

      <div class="flex justify-end">
        <button onclick="toggleModal('start-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition">Cancelar</button>
        <button id="start-session-btn" class="btn-primary bg-[#00d073] text-[#161b22] font-bold py-2 px-4 rounded-lg">Comenzar Juego</button>
      </div>
      <p id="start-modal-error" class="text-sm text-red-400 mt-3 hidden">Debe ingresar el nombre del cliente.</p>
    </div>
  </div>

  <!-- Controles Globales -->
  <div class="flex justify-center mb-8 gap-3 flex-wrap">
    <button onclick="toggleModal('price-modal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
      ‚öôÔ∏è Configurar Tarifas (HNL)
    </button>

    <button onclick="dailyCut()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
      üìä Corte del D√≠a
    </button>

    <button onclick="window.location.reload()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition">
      üîÑ Recargar App
    </button>
  </div>

  <!-- Dashboard de Consolas -->
  <div id="consoles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div id="zone_1_card" class="console-card p-6 rounded-xl shadow-lg"></div>
    <div id="zone_2_card" class="console-card p-6 rounded-xl shadow-lg"></div>
    <div id="zone_3_card" class="console-card p-6 rounded-xl shadow-lg"></div>
    <div id="zone_4_card" class="console-card p-6 rounded-xl shadow-lg"></div>
  </div>

  <!-- Secci√≥n de Precios Actuales -->
  <div class="mt-12 p-6 bg-[#161b22] rounded-xl border border-[#30363d]">
    <h2 class="text-xl font-bold mb-3 text-gray-300">Tarifas Actuales (HNL)</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
      <p><strong>Costo/Hora:</strong> <span id="display-price-hour" class="text-[#00f080] font-semibold">Cargando...</span></p>
      <p><strong>Costo/Media Hora:</strong> <span id="display-price-half-hour" class="text-[#00f080] font-semibold">Cargando...</span></p>
      <p><strong>Control Extra:</strong> <span id="display-price-extra-controller" class="text-[#00f080] font-semibold">Cargando...</span></p>
    </div>
  </div>

  <!-- Listado de Clientes -->
  <div class="mt-8 p-6 bg-[#161b22] rounded-xl border border-[#30363d]">
    <h2 class="text-xl font-bold mb-3 text-gray-300">Clientes Registrados (CRM)</h2>
    <div id="client-list" class="space-y-3 max-h-60 overflow-y-auto">
      <p class="text-gray-500" id="loading-clients">Cargando clientes...</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc, collection, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let db;
    let auth;
    let userId = null;
    let prices = {};
    let allClients = [];

    const ZONES = ['zone_1', 'zone_2', 'zone_3', 'zone_4'];
    const ZONE_NAMES = {
      'zone_1': 'Consola 1',
      'zone_2': 'Consola 2',
      'zone_3': 'Consola 3',
      'zone_4': 'Consola 4',
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const firebaseConfig = {
      apiKey: "AIzaSyAQu44JnfISym09YL0bpgGa0Nwz9h-FojE",
      authDomain: "angeloshop-ea79f.firebaseapp.com",
      projectId: "angeloshop-ea79f",
      storageBucket: "angeloshop-ea79f.firebasestorage.app",
      messagingSenderId: "935655080584",
      appId: "1:935655080584:web:3fed0b05760fa2b428d53d",
      measurementId: "G-XM982FSEVP"
    };

    const PUBLIC_CONFIG_PATH = `artifacts/${appId}/public/data/gaming_zone_config/prices`;
    const PUBLIC_ZONES_COLLECTION_PATH = `artifacts/${appId}/public/data/gaming_zone_status`;
    const PUBLIC_CLIENTS_COLLECTION_PATH = `artifacts/${appId}/public/data/client_records`;
    const PUBLIC_SESSIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/client_sessions`;

    const normalizeHNPhone = (input) => {
      if (!input) return "";
      let s = String(input).trim();
      s = s.replace(/[^\d+]/g, "");
      if (s.startsWith("+504")) return s;
      if (s.startsWith("504") && s.length === 11) return `+${s}`;
      const digits = s.replace(/\D/g, "");
      if (digits.length === 8) return `+504${digits}`;
      if (s.startsWith("+")) return s;
      return digits ? `+504${digits}` : "";
    };

    const formatTime = (ms) => {
      if (ms < 0) ms = 0;
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    };

    const sendWhatsappMessage = (e164Phone, message) => {
      const phoneDigits = (e164Phone || "").replace(/\D/g, "");
      if (!phoneDigits) return;
      const url = `https://wa.me/${phoneDigits}?text=${encodeURIComponent(message)}`;
      window.open(url, "_blank");
    };

    const getElapsedBadgeClass = (elapsedMs) => {
      const mins = Math.floor(elapsedMs / 60000);
      if (mins >= 60) return "text-red-400";
      if (mins >= 30) return "text-yellow-300";
      return "text-green-300";
    };

    const saveLocalBackupZone = (zoneId, data) => {
      try { localStorage.setItem(`tpv_zone_${zoneId}`, JSON.stringify(data)); } catch {}
    };
    const loadLocalBackupZone = (zoneId) => {
      try { const raw = localStorage.getItem(`tpv_zone_${zoneId}`); return raw ? JSON.parse(raw) : null; } catch { return null; }
    };

    window.toggleModal = (modalId, show = null) => {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      if (show === true || (show === null && modal.classList.contains('hidden'))) modal.classList.remove('hidden');
      else if (show === false || (show === null && !modal.classList.contains('hidden'))) modal.classList.add('hidden');
    };

    const alertUser = (message) => {
      const existingAlert = document.getElementById('custom-alert');
      if (existingAlert) existingAlert.remove();

      const alertHtml = `
        <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-80 z-[100] flex justify-center items-center p-4">
          <div class="bg-[#1e2329] p-8 rounded-xl w-full max-w-sm shadow-2xl border-t-4 border-[#00f080]">
            <h3 class="text-xl font-bold mb-4 text-[#00f080]">Cobro Total</h3>
            <pre class="whitespace-pre-wrap text-gray-200 text-sm mb-6">${String(message).trim()}</pre>
            <button onclick="document.getElementById('custom-alert').remove()"
                    class="w-full btn-primary bg-[#00d073] text-[#161b22] font-bold py-2 rounded-lg">CERRAR</button>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', alertHtml);
    };

    const confirmAction = (title, details, onConfirm) => {
      const existing = document.getElementById('custom-confirm');
      if (existing) existing.remove();

      const html = `
        <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-80 z-[101] flex justify-center items-center p-4">
          <div class="bg-[#1e2329] p-8 rounded-xl w-full max-w-sm shadow-2xl border-t-4 border-yellow-400">
            <h3 class="text-xl font-bold mb-3 text-yellow-300">${title}</h3>
            <pre class="whitespace-pre-wrap text-gray-200 text-sm mb-6">${String(details).trim()}</pre>
            <div class="flex gap-3">
              <button id="confirm-no" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">Cancelar</button>
              <button id="confirm-yes" class="w-1/2 btn-primary bg-[#00d073] text-[#161b22] font-bold py-2 rounded-lg">Confirmar</button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);

      document.getElementById("confirm-no").onclick = () => document.getElementById('custom-confirm').remove();
      document.getElementById("confirm-yes").onclick = () => {
        document.getElementById('custom-confirm').remove();
        onConfirm();
      };
    };

    window.calculateCost = (elapsedMs, extraControllers) => {
      if (elapsedMs <= 0 || prices.costPerHour == null || prices.costPerHalfHour == null) return 0;

      const costPerHour = parseFloat(prices.costPerHour) || 0;
      const costPerHalfHour = parseFloat(prices.costPerHalfHour) || 0;
      const extraControllerFee = parseFloat(prices.extraControllerFee) || 0;

      let totalTimeCost = 0;
      const totalMinutes = Math.ceil(elapsedMs / (1000 * 60));

      if (totalMinutes <= 30) {
        totalTimeCost = costPerHalfHour;
      } else {
        const hours = Math.floor(totalMinutes / 60);
        const remainingMinutes = totalMinutes % 60;

        totalTimeCost += hours * costPerHour;
        if (remainingMinutes > 30) totalTimeCost += costPerHour;
        else if (remainingMinutes > 0) totalTimeCost += costPerHalfHour;
      }

      return totalTimeCost + (extraControllers * extraControllerFee);
    };

    const nextInvoiceNumber = async () => {
      const ref = doc(db, PUBLIC_CONFIG_PATH);
      const snap = await getDoc(ref);
      const current = snap.exists() ? (snap.data().invoiceSeq || 0) : 0;
      const next = current + 1;

      await updateDoc(ref, { invoiceSeq: next }).catch(async () => {
        await setDoc(ref, { invoiceSeq: next }, { merge: true });
      });

      return `ZJ-${String(next).padStart(6, "0")}`;
    };

    const setDefaultPrices = async () => {
      if (!db) return;
      const defaultPrices = { costPerHour: 30, costPerHalfHour: 20, extraControllerFee: 5, invoiceSeq: 0 };
      try {
        await setDoc(doc(db, PUBLIC_CONFIG_PATH), defaultPrices, { merge: true });
        prices = { ...defaultPrices, ...prices };
        updatePriceUI(prices);
      } catch (e) {
        console.error("Error setting default prices:", e);
      }
    };

    window.savePrices = async () => {
      if (!db) return;
      const priceHour = parseFloat(document.getElementById('price-hour').value);
      const priceHalfHour = parseFloat(document.getElementById('price-half-hour').value);
      const priceExtra = parseFloat(document.getElementById('price-extra-controller').value);
      const errorElement = document.getElementById('price-error');
      errorElement.classList.add('hidden');

      if ([priceHour, priceHalfHour, priceExtra].some(v => Number.isNaN(v) || v < 0)) {
        errorElement.textContent = 'Aseg√∫rate de que todos los valores son n√∫meros v√°lidos y positivos.';
        errorElement.classList.remove('hidden');
        return;
      }

      try {
        await setDoc(doc(db, PUBLIC_CONFIG_PATH), {
          costPerHour: priceHour,
          costPerHalfHour: priceHalfHour,
          extraControllerFee: priceExtra
        }, { merge: true });
        toggleModal('price-modal', false);
      } catch (e) {
        console.error("Error saving prices:", e);
        errorElement.textContent = 'Error al guardar en la base de datos.';
        errorElement.classList.remove('hidden');
      }
    };

    const updatePriceUI = (currentPrices) => {
      const formatCurrency = (value) => (value != null) ? `L${Number(value).toFixed(2)}` : 'N/A';
      document.getElementById('display-price-hour').textContent = formatCurrency(currentPrices.costPerHour);
      document.getElementById('display-price-half-hour').textContent = formatCurrency(currentPrices.costPerHalfHour);
      document.getElementById('display-price-extra-controller').textContent = formatCurrency(currentPrices.extraControllerFee);

      document.getElementById('price-hour').value = Number(currentPrices.costPerHour || 0);
      document.getElementById('price-half-hour').value = Number(currentPrices.costPerHalfHour || 0);
      document.getElementById('price-extra-controller').value = Number(currentPrices.extraControllerFee || 0);
    };

    window.searchClients = (query) => {
      const suggestionsEl = document.getElementById('client-suggestions');
      suggestionsEl.innerHTML = '';
      if ((query || '').length < 2) return;

      const filtered = allClients
        .filter(client =>
          (client.name || '').toLowerCase().includes(query.toLowerCase()) ||
          (client.whatsapp || '').includes(query)
        )
        .slice(0, 5);

      filtered.forEach(client => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.textContent = `${client.name} (${client.whatsapp || 'Sin WhatsApp'}) - Visitas: ${client.visitCount || 0}`;
        item.onclick = () => selectClient(client);
        suggestionsEl.appendChild(item);
      });
    };

    const selectClient = (client) => {
      document.getElementById('client-name-input').value = client.name || '';
      document.getElementById('client-whatsapp-input').value = client.whatsapp || '';
      document.getElementById('client-db-id').value = client.id || '';
      document.getElementById('client-suggestions').innerHTML = '';
    };

    const renderClientList = () => {
      const listElement = document.getElementById('client-list');
      listElement.innerHTML = '';

      const sortedClients = [...allClients].sort((a, b) => {
        if ((b.visitCount || 0) !== (a.visitCount || 0)) return (b.visitCount || 0) - (a.visitCount || 0);
        return (a.name || '').localeCompare(b.name || '');
      });

      if (sortedClients.length === 0) {
        listElement.innerHTML = `<p class="text-gray-500">No hay clientes registrados.</p>`;
        return;
      }

      sortedClients.forEach(client => {
        const date = client.lastVisit ? new Date(client.lastVisit).toLocaleDateString() : 'N/A';
        const whatsappE164 = client.whatsapp || "";
        const whatsappForLink = whatsappE164.replace("+", "");

        const whatsappLink = whatsappE164
          ? `<a href="https://wa.me/${whatsappForLink}" target="_blank" class="text-blue-400 hover:text-blue-300 ml-2">(üì≤ ${whatsappE164})</a>`
          : '';

        const vip = (client.visitCount || 0) >= 10;

        listElement.innerHTML += `
          <div class="p-3 bg-[#1e2329] rounded-lg flex justify-between items-center text-sm">
            <div>
              <span class="font-semibold text-white">${client.name || ''}</span>
              ${vip ? `<span class="text-yellow-300 font-bold ml-1">‚≠ê VIP</span>` : ''}
              ${whatsappLink}
            </div>
            <div class="text-right text-gray-400">
              <p>Visitas: <span class="font-bold text-[#00f080]">${client.visitCount || 1}</span></p>
              <p class="text-xs">√öltima: ${date}</p>
            </div>
          </div>
        `;
      });
    };

    window.openStartModal = async (zoneId) => {
      if (!db) return;

      // Bloqueo real consultando Firestore (evita doble sesi√≥n aunque el UI est√© desfasado)
      const snap = await getDoc(doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId));
      if (snap.exists() && snap.data().status === 'Occupied') {
        alertUser("Esta consola ya est√° ocupada.");
        return;
      }

      document.getElementById('client-name-input').value = '';
      document.getElementById('client-whatsapp-input').value = '';
      document.getElementById('client-db-id').value = '';
      document.getElementById('client-suggestions').innerHTML = '';
      document.getElementById('start-modal-error').classList.add('hidden');

      document.getElementById('start-modal-title').textContent = `Iniciar Sesi√≥n en ${ZONE_NAMES[zoneId]}`;
      const startBtn = document.getElementById('start-session-btn');
      startBtn.onclick = () => startSession(zoneId);

      document.getElementById('session-controllers').value = 0;
      document.getElementById('session-console').value = 'PS4';
      toggleModal('start-modal', true);
    };

    const startSession = async (zoneId) => {
      if (!db) return;

      const clientNameRaw = document.getElementById('client-name-input').value.trim();
      const clientWhatsappRaw = document.getElementById('client-whatsapp-input').value.trim();
      const clientDbId = document.getElementById('client-db-id').value;
      const consoleType = document.getElementById('session-console').value;
      const extraControllers = Math.max(0, Math.min(4, parseInt(document.getElementById('session-controllers').value, 10) || 0));

      const errorElement = document.getElementById('start-modal-error');
      errorElement.classList.add('hidden');

      if (!clientNameRaw) {
        errorElement.textContent = 'El nombre del cliente es obligatorio para el registro.';
        errorElement.classList.remove('hidden');
        return;
      }

      const finalClientName = clientNameRaw.charAt(0).toUpperCase() + clientNameRaw.slice(1).toLowerCase();
      const finalClientWhatsapp = normalizeHNPhone(clientWhatsappRaw);

      // Registrar/Actualizar Cliente
      let clientFinalId = "";

      try {
        const currentClientData = allClients.find(c => c.id === clientDbId);

        if (currentClientData) {
          const clientRef = doc(db, PUBLIC_CLIENTS_COLLECTION_PATH, currentClientData.id);
          await updateDoc(clientRef, {
            whatsapp: finalClientWhatsapp,
            lastVisit: Date.now(),
            visitCount: (currentClientData.visitCount || 0) + 1
          });
          clientFinalId = currentClientData.id;
        } else {
          const newClientData = {
            name: finalClientName,
            whatsapp: finalClientWhatsapp,
            lastVisit: Date.now(),
            visitCount: 1
          };
          const newClientDocRef = doc(collection(db, PUBLIC_CLIENTS_COLLECTION_PATH));
          await setDoc(newClientDocRef, newClientData);
          clientFinalId = newClientDocRef.id;
        }
      } catch (e) {
        console.error("Error saving client:", e);
        errorElement.textContent = 'Error al guardar cliente.';
        errorElement.classList.remove('hidden');
        return;
      }

      // Iniciar la Sesi√≥n
      const newSession = {
        id: zoneId,
        name: ZONE_NAMES[zoneId],
        console: consoleType,
        status: 'Occupied',
        startTime: Date.now(),
        extraControllers,
        clientName: finalClientName,
        clientWhatsapp: finalClientWhatsapp,
        clientId: clientFinalId,
        currentTotal: 0
      };

      try {
        await setDoc(doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId), newSession);
        saveLocalBackupZone(zoneId, newSession);
        toggleModal('start-modal', false);
      } catch (e) {
        console.error("Error starting session:", e);
        errorElement.textContent = 'Error al iniciar la sesi√≥n.';
        errorElement.classList.remove('hidden');
      }
    };

    window.addExtraController = async (zoneId) => {
      const ref = doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const data = snap.data();
      if (data.status !== "Occupied") return;

      const next = Math.min((data.extraControllers || 0) + 1, 4);
      await updateDoc(ref, { extraControllers: next }).catch(console.error);
    };

    window.removeExtraController = async (zoneId) => {
      const ref = doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const data = snap.data();
      if (data.status !== "Occupied") return;

      const next = Math.max((data.extraControllers || 0) - 1, 0);
      await updateDoc(ref, { extraControllers: next }).catch(console.error);
    };

    window.endSession = async (zoneId) => {
      if (!db) return;

      const docRef = doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;

      const data = docSnap.data();
      if (data.status !== 'Occupied' || !data.startTime) {
        alertUser("Esta consola no tiene sesi√≥n activa.");
        return;
      }

      const elapsedMs = Date.now() - data.startTime;
      const finalCost = window.calculateCost(elapsedMs, data.extraControllers || 0);
      const finalTime = formatTime(elapsedMs);

      const startDate = new Date(data.startTime);
      const endDate = new Date();

      const preview =
        `Consola: ${data.name} (${data.console})\n` +
        `Cliente: ${data.clientName || "N/A"}\n` +
        `Tiempo: ${finalTime}\n` +
        `Total: L${finalCost.toFixed(2)} HNL`;

      confirmAction("¬øFinalizar sesi√≥n?", preview, async () => {
        let invoiceNo = "";
        try { invoiceNo = await nextInvoiceNumber(); }
        catch { invoiceNo = `ZJ-${Date.now()}`; }

        const invoiceMsg =
          `üßæ *FACTURA - ZONA DE JUEGOS*\n` +
          `--------------------------------\n` +
          `Factura #: ${invoiceNo}\n` +
          `Fecha: ${endDate.toLocaleString()}\n\n` +
          `Cliente: ${data.clientName || "N/A"}\n` +
          `WhatsApp: ${data.clientWhatsapp || "N/A"}\n` +
          `Consola: ${data.name} (${data.console})\n\n` +
          `Inicio: ${startDate.toLocaleTimeString()}\n` +
          `Fin: ${endDate.toLocaleTimeString()}\n` +
          `Tiempo total: ${finalTime}\n\n` +
          `Tarifa hora: L${Number(prices.costPerHour || 0).toFixed(2)}\n` +
          `Tarifa 1/2 hora: L${Number(prices.costPerHalfHour || 0).toFixed(2)}\n` +
          `Control extra: L${Number(prices.extraControllerFee || 0).toFixed(2)} x ${(data.extraControllers || 0)}\n\n` +
          `TOTAL: *L${finalCost.toFixed(2)} HNL*\n` +
          `--------------------------------\n` +
          `Vuelve pronto. Gracias por tu compra. üéÆ`;

        alertUser(`
‚úÖ Sesi√≥n Finalizada
-------------------------------------
Factura: ${invoiceNo}
Consola: ${data.name} (${data.console})
Cliente: ${data.clientName || 'N/A'}
WhatsApp: ${data.clientWhatsapp || 'N/A'}
Inicio: ${startDate.toLocaleTimeString()}
Fin: ${endDate.toLocaleTimeString()}
Tiempo Total: ${finalTime}
Controles Extra: ${data.extraControllers || 0}
Total: L${finalCost.toFixed(2)} HNL
-------------------------------------
Vuelve pronto.
        `);

        // Guardar sesi√≥n hist√≥rica
        try {
          const sessionsRef = collection(db, PUBLIC_SESSIONS_COLLECTION_PATH);
          const sessionDoc = doc(sessionsRef);
          await setDoc(sessionDoc, {
            invoiceNo,
            zoneId,
            zoneName: data.name,
            console: data.console,
            clientId: data.clientId || "",
            clientName: data.clientName || "",
            clientWhatsapp: data.clientWhatsapp || "",
            startTime: data.startTime,
            endTime: Date.now(),
            elapsedMs,
            totalTime: finalTime,
            extraControllers: data.extraControllers || 0,
            totalCost: finalCost,
            pricesSnapshot: {
              costPerHour: Number(prices.costPerHour || 0),
              costPerHalfHour: Number(prices.costPerHalfHour || 0),
              extraControllerFee: Number(prices.extraControllerFee || 0),
            },
            createdAt: Date.now(),
          });
        } catch (e) {
          console.error("Error saving session history:", e);
        }

        if (data.clientWhatsapp) {
          sendWhatsappMessage(data.clientWhatsapp, invoiceMsg);
        }

        const resetData = {
          id: zoneId,
          name: ZONE_NAMES[zoneId],
          console: data.console,
          status: 'Available',
          startTime: 0,
          extraControllers: 0,
          clientName: '',
          clientWhatsapp: '',
          clientId: '',
          currentTotal: 0
        };

        try {
          await setDoc(doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId), resetData);
          saveLocalBackupZone(zoneId, resetData);
        } catch (e) {
          console.error("Error ending session:", e);
        }
      });
    };

    let intervalId = null;

    const updateTimers = () => {
      if (intervalId) return;

      intervalId = setInterval(() => {
        ZONES.forEach(zoneId => {
          const card = document.getElementById(`${zoneId}_card`);
          const status = card?.getAttribute('data-status');
          const startTime = parseInt(card?.getAttribute('data-start-time'), 10) || 0;
          const extraControllers = parseInt(card?.getAttribute('data-extra-controllers'), 10) || 0;

          if (status === 'Occupied' && startTime > 0) {
            const elapsedMs = Date.now() - startTime;
            const elapsedSeconds = Math.floor(elapsedMs / 1000);

            const timerElement = card.querySelector('.timer-display');
            if (timerElement) {
              timerElement.textContent = formatTime(elapsedMs);
              timerElement.classList.remove("text-green-300","text-yellow-300","text-red-400");
              timerElement.classList.add(getElapsedBadgeClass(elapsedMs));
            }

            if (elapsedSeconds % 5 === 0) {
              const currentCost = window.calculateCost(elapsedMs, extraControllers);
              const costElement = card.querySelector('.cost-display');
              if (costElement) costElement.textContent = `L${currentCost.toFixed(2)} HNL`;
            }
          }
        });
      }, 1000);
    };

    const renderZoneCard = (zoneId, data) => {
      const cardElement = document.getElementById(`${zoneId}_card`);
      if (!cardElement) return;

      const isOccupied = data.status === 'Occupied';
      const statusColor = isOccupied ? 'bg-red-500' : 'bg-green-500';
      const actionButtonClass = isOccupied ? 'bg-red-600 hover:bg-red-700 text-white' : 'btn-primary bg-[#00d073] text-[#161b22]';
      const actionButtonText = isOccupied ? 'FINALIZAR SESI√ìN' : 'INICIAR SESI√ìN';
      const actionButtonOnClick = isOccupied ? `endSession('${zoneId}')` : `openStartModal('${zoneId}')`;

      cardElement.setAttribute('data-status', data.status || 'Available');
      cardElement.setAttribute('data-start-time', data.startTime || 0);
      cardElement.setAttribute('data-extra-controllers', data.extraControllers || 0);

      let content = `
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-200">${ZONE_NAMES[zoneId]}</h2>
          <span class="text-sm font-medium ${isOccupied ? 'text-red-400' : 'text-green-400'} flex items-center">
            <span class="status-dot ${statusColor} mr-2"></span>
            ${isOccupied ? 'OCUPADA' : 'DISPONIBLE'}
          </span>
        </div>
        <p class="text-xl font-semibold mb-4 text-[#00f080]">${data.console || 'PS4'}</p>
      `;

      if (isOccupied) {
        const elapsedMs = Date.now() - (data.startTime || Date.now());
        const currentCost = window.calculateCost(elapsedMs, data.extraControllers || 0);

        let clientInfoHtml = '';
        if (data.clientName) clientInfoHtml += `<p class="text-lg font-bold text-gray-100">${data.clientName}</p>`;
        if (data.clientWhatsapp) clientInfoHtml += `<p class="text-sm text-gray-400">üì≤ ${data.clientWhatsapp}</p>`;

        content += `
          <div class="mt-4 border-t border-gray-700 pt-4">
            ${clientInfoHtml}
            <p class="text-xs text-gray-400 mt-3 mb-1">TIEMPO TRANSCURRIDO:</p>
            <p class="text-3xl font-mono font-extrabold timer-display ${getElapsedBadgeClass(elapsedMs)}">${formatTime(elapsedMs)}</p>

            <p class="text-xs text-gray-400 mt-3 mb-1">COSTO ACUMULADO:</p>
            <p class="text-2xl font-extrabold text-[#00f080] cost-display">L${currentCost.toFixed(2)} HNL</p>

            <p class="text-xs text-gray-400 mt-3">CONTROLES EXTRA:</p>
            <p class="text-lg font-semibold text-gray-300">${data.extraControllers || 0}</p>

            <div class="mt-3 flex gap-2">
              <button onclick="addExtraController('${zoneId}')" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">
                +1 Control
              </button>
              <button onclick="removeExtraController('${zoneId}')" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">
                -1 Control
              </button>
            </div>
          </div>
        `;
      } else {
        content += `
          <div class="h-24 flex items-center justify-center">
            <p class="text-gray-500 italic">Lista para iniciar una nueva sesi√≥n.</p>
          </div>
        `;
      }

      content += `
        <button onclick="${actionButtonOnClick}" class="w-full mt-6 py-3 px-4 rounded-lg font-bold ${actionButtonClass} transition">
          ${actionButtonText}
        </button>
      `;

      cardElement.innerHTML = content;

      if (isOccupied) updateTimers();
    };

    window.dailyCut = async () => {
      if (!db) return;

      const start = new Date();
      start.setHours(0,0,0,0);
      const startMs = start.getTime();
      const endMs = Date.now();

      const snap = await getDocs(collection(db, PUBLIC_SESSIONS_COLLECTION_PATH));

      let total = 0;
      let count = 0;
      let totalMs = 0;
      const byZone = {};

      snap.forEach(d => {
        const s = d.data();
        const t = s.createdAt || s.endTime || 0;
        if (t >= startMs && t <= endMs) {
          count++;
          total += Number(s.totalCost || 0);
          totalMs += Number(s.elapsedMs || 0);
          const key = s.zoneName || s.zoneId || "N/A";
          byZone[key] = (byZone[key] || 0) + Number(s.totalCost || 0);
        }
      });

      const best = Object.entries(byZone).sort((a,b) => b[1]-a[1])[0];
      const bestTxt = best ? `${best[0]} (L${best[1].toFixed(2)})` : "N/A";

      alertUser(`
üìä CORTE DEL D√çA
Fecha: ${new Date().toLocaleDateString()}
-------------------------------------
Sesiones: ${count}
Total vendido: L${total.toFixed(2)} HNL
Tiempo total: ${formatTime(totalMs)}
Mejor consola: ${bestTxt}
-------------------------------------
      `);
    };

    const startListeners = () => {
      if (!db) return;

      // Precios
      onSnapshot(doc(db, PUBLIC_CONFIG_PATH), (docSnap) => {
        if (docSnap.exists()) {
          prices = docSnap.data();
          updatePriceUI(prices);
        } else {
          setDefaultPrices();
        }
      }, (error) => console.error("Error fetching prices:", error));

      // Zonas
      ZONES.forEach(zoneId => {
        const zoneDocRef = doc(db, PUBLIC_ZONES_COLLECTION_PATH, zoneId);
        onSnapshot(zoneDocRef, (docSnap) => {
          const backup = loadLocalBackupZone(zoneId);
          const data = docSnap.exists()
            ? docSnap.data()
            : (backup || {
              id: zoneId,
              name: ZONE_NAMES[zoneId],
              console: 'PS4',
              status: 'Available',
              startTime: 0,
              extraControllers: 0,
              clientName: '',
              clientWhatsapp: '',
              clientId: '',
              currentTotal: 0
            });

          saveLocalBackupZone(zoneId, data);
          renderZoneCard(zoneId, data);
        }, (error) => console.error(`Error fetching zone ${zoneId}:`, error));
      });

      // Clientes
      onSnapshot(collection(db, PUBLIC_CLIENTS_COLLECTION_PATH), (querySnapshot) => {
        allClients = [];
        querySnapshot.forEach((d) => allClients.push({ id: d.id, ...d.data() }));
        renderClientList();
      }, (error) => console.error("Error fetching clients:", error));
    };

    const initializeFirebase = async () => {
      if (!firebaseConfig?.apiKey) {
        console.error("Firebase config not available or incomplete.");
        document.getElementById('auth-status').textContent = 'Error: Configuraci√≥n de Firebase incompleta.';
        return;
      }

      setLogLevel('Debug');

      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      document.getElementById('auth-status').textContent = 'Autenticando...';

      try {
        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
        else await signInAnonymously(auth);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            document.getElementById('auth-status').textContent = `Autenticado. ID Usuario: ${userId}`;
            startListeners();
          } else {
            userId = null;
            document.getElementById('auth-status').textContent = 'Desconectado.';
          }
        });
      } catch (error) {
        console.error("Error during Firebase auth:", error);
        document.getElementById('auth-status').textContent = 'Error de Autenticaci√≥n.';
      }
    };

    window.onload = initializeFirebase;
  </script>
</body>
</html>
