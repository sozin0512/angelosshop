<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANGELO´S SHOP - Tienda & Admin</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js (for Admin Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .font-script {
            font-family: 'Dancing Script', cursive;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #fca5a5; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f87171; 
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- =========================
         VISTA DE TIENDA (STORE) 
         ========================= -->
    <div id="store-view" class="animate-fade-in pb-32">
        
        <!-- Top Header -->
        <header class="sticky top-0 z-50 bg-white border-b border-gray-100 shadow-sm">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    
                    <!-- Left: Hamburger Menu (Mobile) -->
                    <div class="flex items-center">
                        <button class="p-2 hover:bg-gray-100 rounded-full lg:hidden text-xl">
                            <i class="fas fa-bars"></i>
                        </button>
                        <!-- Desktop Menu Trigger (Hidden on Mobile) -->
                        <button class="hidden lg:block p-2 text-xl hover:text-pink-500">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>

                    <!-- Center: Logo -->
                    <div class="flex-1 text-center">
                        <a href="#" onclick="toggleView('store')" class="text-4xl md:text-5xl font-script text-pink-400 hover:text-pink-500 transition duration-300">
                            ANGELO´S SHOP
                        </a>
                    </div>

                    <!-- Right: Icons -->
                    <div class="flex items-center space-x-4 md:space-x-6 text-xl">
                        <button class="hover:text-pink-500 transition"><i class="far fa-heart"></i></button>
                        
                        <!-- Login / User Button -->
                        <button onclick="handleUserIconClick()" class="hover:text-pink-500 transition relative group">
                            <i class="far fa-user"></i>
                            <span id="user-status-dot" class="absolute top-0 right-0 h-2 w-2 bg-green-500 rounded-full hidden"></span>
                        </button>

                        <button class="hover:text-pink-500 transition"><i class="fas fa-search"></i></button>
                        <button class="relative hover:text-pink-500 transition">
                            <i class="fas fa-shopping-bag"></i>
                            <span id="cart-badge" class="absolute -top-2 -right-2 bg-orange-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Menu (Desktop) -->
            <nav class="hidden lg:block border-t border-b border-gray-200 py-4 mt-2">
                <ul class="flex justify-center space-x-8 text-[15px] font-medium text-gray-800 tracking-wide">
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Inicio <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Skincare <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Ojos <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Cejas <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Labios <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Rostro <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Accesorios <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="group relative cursor-pointer hover:text-pink-500 flex items-center transition-colors">
                        Manos y Pies <i class="fas fa-chevron-down ml-2 text-[10px] text-gray-500"></i>
                    </li>
                    <li class="hover:text-pink-500 cursor-pointer transition-colors">Cabello</li>
                    <li class="hover:text-pink-500 cursor-pointer transition-colors">Marcas</li>
                    <li class="hover:text-pink-500 cursor-pointer transition-colors">Contáctanos</li>
                </ul>
            </nav>
        </header>

        <!-- User Welcome Banner (Hidden by default) -->
        <div id="user-banner" class="hidden bg-pink-50 text-center py-2 text-sm text-pink-600 font-medium animate-fade-in">
            Hola, <span id="user-name-display">Usuario</span>. ¡Bienvenida de nuevo!
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Productos Destacados</h2>
            
            <!-- Loading State -->
            <div id="loading-indicator" class="text-center py-10">
                <i class="fas fa-spinner fa-spin text-4xl text-pink-300"></i>
                <p class="mt-2 text-gray-400">Cargando productos de la base de datos...</p>
            </div>

            <!-- Dynamic Product Grid -->
            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 hidden">
                <!-- Products will be injected here by JS -->
            </div>

            <!-- Footer Note -->
            <div class="mt-12 text-center pb-8 border-t border-gray-100 pt-8">
                <p class="text-gray-400 text-sm">© 2024 Ellas Beauty. Todos los derechos reservados.</p>
            </div>
        </main>

        <!-- WhatsApp Floating -->
        <a href="#" class="fixed bottom-24 lg:bottom-28 left-6 z-40 bg-pink-300 hover:bg-pink-400 text-white p-3 rounded-full shadow-lg transition transform hover:scale-110 flex items-center justify-center w-14 h-14">
            <i class="fab fa-whatsapp text-3xl"></i>
        </a>

        <!-- Sticky Bottom Product Bar -->
        <div id="sticky-bar" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] p-3 z-50 transition-transform duration-300 translate-y-full">
            <div class="container mx-auto max-w-6xl flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="w-12 h-12 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                         <img id="sticky-img" src="" alt="Thumbnail" class="object-cover w-full h-full">
                    </div>
                    <div class="flex flex-col">
                        <h4 id="sticky-title" class="font-medium text-sm md:text-base truncate max-w-[200px] md:max-w-md">Product Name</h4>
                        <span id="sticky-price" class="font-semibold text-gray-800">L 0</span>
                    </div>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                    <div class="flex items-center border border-gray-300 rounded">
                        <button onclick="updateQuantity(-1)" class="px-3 py-2 text-gray-500 hover:bg-gray-100">-</button>
                        <input type="text" id="quantity" value="1" class="w-10 text-center border-none focus:outline-none font-medium" readonly>
                        <button onclick="updateQuantity(1)" class="px-3 py-2 text-gray-500 hover:bg-gray-100">+</button>
                    </div>
                    <button onclick="addToCart()" class="bg-[#f25c2e] hover:bg-[#d94b20] text-white font-bold py-2 px-6 rounded text-sm uppercase transition shadow-lg">
                        Añadir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================
         LOGIN MODAL
         ========================= -->
    <div id="login-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 relative transform transition-all scale-100">
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="font-script text-4xl text-pink-500 mb-2">Ellas Beauty</h2>
                <p class="text-gray-500 text-sm">Bienvenida, por favor inicia sesión</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                    <div class="relative">
                        <i class="far fa-envelope absolute left-3 top-3 text-gray-400"></i>
                        <input type="email" id="login-email" required placeholder="tu@correo.com" class="pl-10 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                        <input type="password" id="login-password" required placeholder="••••••••" class="pl-10 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:outline-none">
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-lg transition shadow-md mt-2">
                    Iniciar Sesión
                </button>
            </form>

            <div class="mt-6 text-center border-t border-gray-100 pt-4">
                <p class="text-xs text-gray-400">
                    <i class="fas fa-info-circle mr-1"></i> Tip: Usa <span class="font-mono bg-gray-100 px-1 rounded">admin@ellas.com</span> / <span class="font-mono bg-gray-100 px-1 rounded">admin123</span> para entrar al panel.
                </p>
            </div>
        </div>
    </div>

    <!-- =========================
         VISTA DE ADMIN (DASHBOARD) 
         ========================= -->
    <div id="admin-view" class="hidden h-screen flex overflow-hidden bg-gray-100">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6 text-center border-b border-gray-100">
                <h1 class="font-script text-3xl text-pink-500">Ellas Admin</h1>
                <p class="text-xs text-green-500 mt-1 font-medium">● En línea</p>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-2">
                    <li>
                        <button onclick="switchAdminTab('dashboard')" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-pink-50 hover:text-pink-500 font-medium transition active-tab">
                            <i class="fas fa-chart-line w-6"></i> Dashboard
                        </button>
                    </li>
                    <li>
                        <button onclick="switchAdminTab('products')" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-pink-50 hover:text-pink-500 font-medium transition">
                            <i class="fas fa-box-open w-6"></i> Productos
                        </button>
                    </li>
                    <li>
                        <button onclick="switchAdminTab('sales')" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-pink-50 hover:text-pink-500 font-medium transition">
                            <i class="fas fa-shopping-cart w-6"></i> Ventas
                        </button>
                    </li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button onclick="handleLogout()" class="w-full bg-red-50 text-red-500 py-2 rounded-lg hover:bg-red-100 transition font-medium text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- Main Admin Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Mobile Admin Header -->
            <header class="md:hidden bg-white border-b p-4 flex justify-between items-center">
                <span class="font-script text-2xl text-pink-500">Ellas Admin</span>
                <button onclick="handleLogout()" class="text-sm text-red-500 font-medium">Salir</button>
            </header>

            <!-- Admin Content Pages -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
                
                <!-- 1. Dashboard Tab -->
                <div id="tab-dashboard" class="admin-content block">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Resumen General</h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-pink-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-gray-500">Ventas Totales</p>
                                    <h3 class="text-2xl font-bold text-gray-800">L 145,200</h3>
                                </div>
                                <div class="bg-pink-100 p-3 rounded-full text-pink-500"><i class="fas fa-dollar-sign"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-gray-500">Pedidos Hoy</p>
                                    <h3 class="text-2xl font-bold text-gray-800">12</h3>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full text-blue-500"><i class="fas fa-shopping-bag"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-gray-500">Productos Activos</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="total-products-count">...</h3>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-full text-purple-500"><i class="fas fa-tag"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Table -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Actividad Reciente</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-sm text-gray-500 border-b border-gray-100">
                                        <th class="py-3 font-medium">Pedido ID</th>
                                        <th class="py-3 font-medium">Cliente</th>
                                        <th class="py-3 font-medium">Estado</th>
                                        <th class="py-3 font-medium text-right">Monto</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm">
                                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                                        <td class="py-3 text-pink-500">#ORD-001</td>
                                        <td class="py-3">María González</td>
                                        <td class="py-3"><span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">Completado</span></td>
                                        <td class="py-3 text-right">L 1,485</td>
                                    </tr>
                                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                                        <td class="py-3 text-pink-500">#ORD-002</td>
                                        <td class="py-3">Ana Hernandez</td>
                                        <td class="py-3"><span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs">Pendiente</span></td>
                                        <td class="py-3 text-right">L 850</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. Products Tab -->
                <div id="tab-products" class="admin-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Inventario de Productos</h2>
                        <button onclick="openAddProductModal()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-plus mr-2"></i> Nuevo Producto
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-800 font-medium border-b">
                                <tr>
                                    <th class="px-6 py-4">Producto</th>
                                    <th class="px-6 py-4">Precio (L)</th>
                                    <th class="px-6 py-4">Stock</th>
                                    <th class="px-6 py-4 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-products-table" class="divide-y divide-gray-100">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. Sales Tab (Placeholder) -->
                <div id="tab-sales" class="admin-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Historial de Ventas</h2>
                    <div class="bg-white p-10 rounded-xl shadow-sm text-center">
                        <div class="text-gray-300 text-6xl mb-4"><i class="fas fa-chart-bar"></i></div>
                        <p class="text-gray-500">Gráficos de ventas detallados aparecerían aquí.</p>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="product-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Nuevo Producto</h3>
            <form onsubmit="handleNewProduct(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label>
                    <input type="text" id="new-name" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Precio (L)</label>
                        <input type="number" id="new-price" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descuento (Opcional)</label>
                        <input type="text" id="new-discount" placeholder="-50%" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL Imagen</label>
                    <input type="url" id="new-image" required placeholder="https://..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-pink-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Usa Unsplash o similar para demo.</p>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeProductModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-pink-500 text-white font-medium rounded-lg hover:bg-pink-600 transition shadow-md">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAQu44JnfISym09YL0bpgGa0Nwz9h-FojE",
            authDomain: "angeloshop-ea79f.firebaseapp.com",
            projectId: "angeloshop-ea79f",
            storageBucket: "angeloshop-ea79f.firebasestorage.app",
            messagingSenderId: "935655080584",
            appId: "1:935655080584:web:3fed0b05760fa2b428d53d",
            measurementId: "G-XM982FSEVP"
        };

        // 2. INIT
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Globals for App Logic
        window.db = db;
        window.products = []; // Will be synced with DB
        window.currentUserRole = null; // 'admin' or 'customer' (UI logic)
        
        // App ID for data path (defaults if undefined)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const productsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'products');

        // 3. AUTH & LOAD DATA
        async function initApp() {
            try {
                // Anonymous sign in to allow database access
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Conectado a Firebase como:", user.uid);
                        subscribeToProducts();
                    }
                });

            } catch (error) {
                console.error("Error connecting to Firebase:", error);
                alert("Error de conexión. Verifica tu consola.");
            }
        }

        // 4. FIRESTORE SYNC
        function subscribeToProducts() {
            onSnapshot(productsCollection, (snapshot) => {
                const loadedProducts = [];
                snapshot.forEach((doc) => {
                    loadedProducts.push({ id: doc.id, ...doc.data() });
                });

                window.products = loadedProducts;

                // Seed initial data if DB is empty
                if (window.products.length === 0) {
                    seedInitialData();
                } else {
                    renderStoreProducts();
                    renderAdminProducts();
                    updateStats();
                    
                    // Hide loading
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('product-grid').classList.remove('hidden');
                }
            }, (error) => {
                console.error("Error fetching products:", error);
            });
        }

        async function seedInitialData() {
            console.log("Seeding initial data...");
            const initialData = [
                { name: "Life Shaver Starter Razor Kit", price: 850, image: "https://images.unsplash.com/photo-1629198688000-71f23e745b6e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80", discount: "50%", stock: 45 },
                { name: "Glazed Donut Serum", price: 1200, image: "https://images.unsplash.com/photo-1616683693504-3ea7e9ad6fec?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80", discount: null, stock: 20 },
                { name: "Glazed Donut Glow Cream", price: 980, image: "https://images.unsplash.com/photo-1608248597279-f99d160bfbc8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80", discount: null, stock: 12 },
                { name: "Acai Your Boobies Serum", price: 1150, image: "https://images.unsplash.com/photo-1620916566398-39f1143ab7be?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80", discount: null, stock: 8 },
                { name: "Smooth Legend After Shave Serum", price: 1485, image: "https://images.unsplash.com/photo-1611930022073-b7a4ba5fcccd?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80", discount: null, stock: 15 }
            ];

            for (const p of initialData) {
                await addDoc(productsCollection, p);
            }
        }

        // Global Wrappers for HTML onclick handlers
        window.handleAddProductToDB = async (productData) => {
            try {
                await addDoc(productsCollection, productData);
                return true;
            } catch (e) {
                console.error("Error adding product:", e);
                alert("Error al guardar en la base de datos");
                return false;
            }
        };

        window.handleDeleteProductFromDB = async (id) => {
            try {
                // Construct specific document path correctly using appId
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', id);
                await deleteDoc(docRef);
                return true;
            } catch (e) {
                console.error("Error deleting product:", e);
                alert("Error al eliminar. Revisa permisos.");
                return false;
            }
        };

        // Initialize Everything
        initApp();
    </script>

    <script>
        // --- UI LOGIC (Interacts with Globals set by Module) ---
        
        // This variable is now managed by Firebase sync
        // let products = ... (REMOVED, using window.products)

        let selectedProduct = null;

        // --- AUTH UI LOGIC ---
        function handleUserIconClick() {
            if (window.currentUserRole) {
                if (window.currentUserRole === 'admin') {
                     toggleView('admin');
                } else {
                    if(confirm("¿Deseas cerrar sesión?")) {
                        handleLogout();
                    }
                }
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }

        function closeLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            // UI Auth Check
            if (email === 'admin@ellas.com' && password === 'admin123') {
                window.currentUserRole = 'admin';
                toggleView('admin');
                closeLoginModal();
                updateUserIconState(true);
            } else {
                window.currentUserRole = 'customer';
                closeLoginModal();
                updateUserIconState(true);
                
                const name = email.split('@')[0];
                document.getElementById('user-name-display').innerText = name.charAt(0).toUpperCase() + name.slice(1);
                document.getElementById('user-banner').classList.remove('hidden');
                document.getElementById('cart-badge').innerText = '2';
            }
        }

        function handleLogout() {
            window.currentUserRole = null;
            toggleView('store');
            updateUserIconState(false);
            document.getElementById('user-banner').classList.add('hidden');
            document.getElementById('cart-badge').innerText = '0';
        }

        function updateUserIconState(isLoggedIn) {
            const dot = document.getElementById('user-status-dot');
            if (isLoggedIn) {
                dot.classList.remove('hidden');
            } else {
                dot.classList.add('hidden');
            }
        }

        // --- NAVIGATION ---
        function toggleView(view) {
            const storeView = document.getElementById('store-view');
            const adminView = document.getElementById('admin-view');
            
            if (view === 'admin') {
                if (window.currentUserRole !== 'admin') {
                    alert("Acceso denegado. Debes iniciar sesión como administrador.");
                    handleUserIconClick(); 
                    return;
                }
                storeView.classList.add('hidden');
                adminView.classList.remove('hidden');
            } else {
                storeView.classList.remove('hidden');
                adminView.classList.add('hidden');
            }
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('bg-pink-50', 'text-pink-500');
                btn.classList.add('text-gray-600');
            });
            event.currentTarget.classList.add('bg-pink-50', 'text-pink-500');
            event.currentTarget.classList.remove('text-gray-600');
        }

        // --- RENDER FUNCTIONS ---
        function renderStoreProducts() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';

            // Use global window.products
            window.products.forEach(p => {
                const discountBadge = p.discount ? 
                    `<span class="absolute top-4 left-4 z-10 bg-black text-white text-xs font-bold px-2 py-3 rounded-full h-12 w-12 flex items-center justify-center">${p.discount}</span>` : '';

                // Escape string properly for onClick
                const safeId = typeof p.id === 'string' ? `'${p.id}'` : p.id;

                const card = `
                <div class="group relative cursor-pointer" onclick="selectProduct(${safeId})">
                    <div class="relative overflow-hidden rounded-lg bg-gray-100 aspect-square mb-2">
                        ${discountBadge}
                        <img src="${p.image}" alt="${p.name}" class="object-cover w-full h-full group-hover:scale-105 transition duration-500">
                        <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col gap-2">
                            <button class="bg-white p-2 rounded-full shadow-md hover:bg-pink-500 hover:text-white transition"><i class="far fa-heart"></i></button>
                            <button class="bg-white p-2 rounded-full shadow-md hover:bg-pink-500 hover:text-white transition"><i class="fas fa-shopping-bag"></i></button>
                        </div>
                    </div>
                    <h3 class="text-sm font-medium text-gray-900 group-hover:text-pink-500 transition">${p.name}</h3>
                    <p class="text-sm text-gray-500">L ${Number(p.price).toLocaleString()}</p>
                </div>
                `;
                grid.innerHTML += card;
            });
        }

        function selectProduct(id) {
            const product = window.products.find(p => p.id == id);
            if (!product) return;
            
            selectedProduct = product;
            
            document.getElementById('sticky-img').src = product.image;
            document.getElementById('sticky-title').innerText = product.name;
            document.getElementById('sticky-price').innerText = `L ${Number(product.price).toLocaleString()}`;
            document.getElementById('quantity').value = 1;

            const bar = document.getElementById('sticky-bar');
            bar.classList.remove('translate-y-full');
        }

        function updateQuantity(change) {
            const qtyInput = document.getElementById('quantity');
            let val = parseInt(qtyInput.value) + change;
            if (val < 1) val = 1;
            qtyInput.value = val;
        }

        function addToCart() {
            const badge = document.getElementById('cart-badge');
            let current = parseInt(badge.innerText);
            let qty = parseInt(document.getElementById('quantity').value);
            
            const btn = document.querySelector('#sticky-bar button[onclick="addToCart()"]');
            const originalText = btn.innerText;
            btn.innerText = "¡Listo!";
            btn.classList.replace('bg-[#f25c2e]', 'bg-green-500');

            setTimeout(() => {
                badge.innerText = current + qty;
                btn.innerText = originalText;
                btn.classList.replace('bg-green-500', 'bg-[#f25c2e]');
                document.getElementById('sticky-bar').classList.add('translate-y-full');
            }, 1000);
        }

        // --- ADMIN RENDER ---
        function updateStats() {
            document.getElementById('total-products-count').innerText = window.products.length;
        }

        function renderAdminProducts() {
            const tbody = document.getElementById('admin-products-table');
            tbody.innerHTML = '';

            window.products.forEach(p => {
                // Escape string properly for onClick
                const safeId = typeof p.id === 'string' ? `'${p.id}'` : p.id;

                const row = `
                <tr class="hover:bg-gray-50 border-b border-gray-100 group">
                    <td class="px-6 py-4 flex items-center gap-3">
                        <img src="${p.image}" class="w-10 h-10 rounded object-cover bg-gray-100">
                        <span class="font-medium text-gray-800">${p.name}</span>
                    </td>
                    <td class="px-6 py-4">L ${p.price}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-bold">${p.stock} un.</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteProduct(${safeId})" class="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- DATABASE ACTIONS ---
        async function deleteProduct(id) {
            if(confirm('¿Estás seguro de eliminar este producto? Esto es permanente.')) {
                // Call global handler defined in module script
                const success = await window.handleDeleteProductFromDB(id);
                if(success) {
                    // UI updates happen automatically via onSnapshot
                    console.log("Producto eliminado");
                }
            }
        }

        function openAddProductModal() {
            document.getElementById('product-modal').classList.remove('hidden');
        }
        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
            document.querySelector('#product-modal form').reset();
        }

        async function handleNewProduct(e) {
            e.preventDefault();
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Guardando...";
            btn.disabled = true;

            const name = document.getElementById('new-name').value;
            const price = parseInt(document.getElementById('new-price').value);
            const discount = document.getElementById('new-discount').value;
            const image = document.getElementById('new-image').value;

            const newProduct = {
                name: name,
                price: price,
                image: image,
                discount: discount || null,
                stock: Math.floor(Math.random() * 50) + 10
            };

            // Call global handler
            const success = await window.handleAddProductToDB(newProduct);
            
            btn.innerText = originalText;
            btn.disabled = false;

            if (success) {
                closeProductModal();
                alert('Producto guardado en Firebase exitosamente');
            }
        }
    </script>
</body>
</html>